@* WEB_Lab13.UI/Components/GameBoard.razor *@
@using WEB_Lab13.Core.Logic
@inject GameClient Client
@implements IDisposable

<h3>Игра Свинья (@_gameState.GameId)</h3>

@if (_gameState.IsGameRunning)
{
    <div class="alert alert-info">
        @_gameState.StatusMessage
    </div>

    <Dice LastRoll="@_gameState.LastRoll" IsRolling="@_isRolling" />

    <div class="card p-3 mb-3">
        <h4>Очки в текущем ходу: <span class="badge bg-warning text-dark">@_gameState.TurnScore</span></h4>
    </div>
    
    @if (IsMyTurn)
    {
        <button class="btn btn-primary" @onclick="Roll" disabled="@(!_gameState.IsGameRunning || _isRolling)">Бросить</button>
        <button class="btn btn-success" @onclick="Hold" disabled="@(_gameState.TurnScore == 0 || _isRolling)">Стоп</button>
    }
    else
    {
        <p class="text-muted">Ожидание хода противника...</p>
    }
}
else
{
    <div class="alert alert-success">@_gameState.StatusMessage</div>
}

<table class="table mt-4">
    <thead>
        <tr>
            <th>Игрок</th>
            <th>Итоговый счет</th>
            <th>Ход</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var player in _gameState.Players)
        {
            <tr class="@(player.IsMyTurn ? "table-active" : "")">
                <td>@player.Username</td>
                <td>@player.TotalScore</td>
                <td>@(player.IsMyTurn ? "➡️" : "")</td>
            </tr>
        }
    </tbody>
</table>

@code {
    [Parameter]
    public GameState GameState { get; set; } = new GameState();

    private GameState _gameState = new GameState();
    private GameState? _previousGameState;
    private bool _isRolling = false;
    private bool IsMyTurn => _gameState.Players.Any(p => p.IsMyTurn && p.ConnectionId == Client.GetConnectionId());

    protected override void OnInitialized()
    {
        _gameState = GameState;
        _previousGameState = GameState;
        Client.GameStateUpdated += OnGameStateUpdated;
    }

    private async void OnGameStateUpdated(GameState newState)
    {
        var turnChanged = _previousGameState?.CurrentPlayerIndex != newState.CurrentPlayerIndex;
        var hasRolled = _previousGameState?.LastRoll != newState.LastRoll && newState.LastRoll != "0 and 0";

        _gameState = newState;

        if (hasRolled)
        {
            _isRolling = true;
            await InvokeAsync(StateHasChanged);
            await Task.Delay(1000); // Must match animation duration
            _isRolling = false;
        }

        if (turnChanged)
        {
            await Task.Delay(1500);
        }

        _previousGameState = newState;
        await InvokeAsync(StateHasChanged);
    }

    private async Task Roll() => await Client.RollDice();
    private async Task Hold() => await Client.Hold();

    public void Dispose()
    {
        Client.GameStateUpdated -= OnGameStateUpdated;
    }
}